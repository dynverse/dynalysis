library(dynbenchmark)
library(tidyverse)
library(patchwork)

experiment("03-method_characterisation")

tool_qc <- read_rds(derived_file("tool_qc.rds"))
tools_evaluated <- read_rds(derived_file("tools_evaluated.rds"))
qc_checks <- readRDS(derived_file("qc_checks.rds"))

# the order of the tools is determined based on overall qc score
tool_order <- tools_evaluated %>%
  arrange(-qc_score) %>%
  filter(!is.na(qc_score)) %>%
  pull(tool_id)
tools_evaluated <- tools_evaluated %>% mutate(tool_id = factor(tool_id, tool_order))

label_tool <- function(tool_id) {tools_evaluated$tool_name[match(tool_id, tools_evaluated$tool_id)]}

# overall ordering plot of the tools
plot_tool_ordering <- tools_evaluated %>%
  ggplot(aes(as.numeric(tool_id), qc_score)) +
  geom_bar(aes(fill=qc_score), stat="identity") +
  geom_text(aes(y=0.015, label=label_tool(tool_id), color=ifelse(qc_score > 0.5, "black", "white")), angle=90, hjust=0, size=3) +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1)) +
  scale_y_continuous(NULL, expand=c(0, 0), limits=c(0, 1)) +
  scale_x_continuous("", breaks=NULL, expand = c(0, 0)) +
  viridis::scale_fill_viridis(label_long("qc_score"), option="D", guide=guide_colorbar(title.position = "top", title.hjust=0.5, barwidth = unit(2, "inches"))) +
  scale_color_identity() +
  annotate("segment", x=-Inf, xend=Inf, y=-Inf, yend=-Inf) +
  theme_pub() +
  theme(legend.position="top")

plot_tool_ordering
plot_tool_ordering %>% write_rds(figure_file("plot_tool_ordering.rds"))

##  ............................................................................
##  Heatmap of the individual aspects of each methods                       ####

# calculate the vertical positions of each aspect & check, based on its weight
qc_checks <- tool_qc %>%
  filter(tool_id == "scorpius") %>%
  group_by(category) %>%
  mutate(normalised_weight = weight/sum(weight)) %>%
  ungroup()


check_positions <- qc_checks %>%
  mutate(
    check_width = item_weight * normalised_weight,
    new_category = c(0, diff(as.numeric(factor(category))) != 0),
    check_end = cumsum(check_width) + cumsum(new_category),
    check_start = lag(check_width, 1, default=0),
    check_mid = mean(c(check_start, check_end))
  ) %>%
  select(check_id, aspect_id, category, check_start, check_end, check_mid)

aspect_positions <- check_positions %>%
  group_by(aspect_id) %>%
  summarise(
    aspect_end = max(check_end),
    aspect_start = min(check_start),
    aspect_mid = mean(c(aspect_start, aspect_end))
  )

category_positions <- check_positions %>%
  group_by(category) %>%
  summarise(
    category_end = max(check_end),
    category_start = min(check_start),
    category_mid = mean(c(category_start, category_end))
  )

hline_check <- geom_hline(aes(yintercept=check_end), data=check_positions, color="#EEEEEE", alpha=0.25)
hline_aspect <- geom_hline(aes(yintercept=aspect_end), data=aspect_positions, color="#EEEEEE")

tool_qc_checks <- tool_qc %>%
  mutate(tool_id = factor(tool_id, tool_order)) %>%
  left_join(check_positions, by=c("check_id","aspect_id")) %>%
  mutate(answer = ifelse(is.na(answer), 0, answer))

plot_individual_checks <- tool_qc_checks %>%
  ggplot() +
  geom_rect(aes(ymax=check_start, ymin=check_end, xmin=as.integer(tool_id), xmax=as.integer(tool_id) + 1, alpha=answer), fill = "#444444") +
  hline_check + hline_aspect +
  geom_vline(aes(xintercept = as.integer(tool_id)), color="white", alpha=0.2) +
  scale_y_reverse(NULL, breaks = aspect_position$aspect_mid, labels = aspect_position$name, expand = c(0, 0)) +
  # scale_x_continuous("", breaks = seq_along(levels(implementation_qc_checks$implementation_id))+0.5, labels = label_implementation(levels(implementation_qc_checks$implementation_id)), expand = c(0, 0), position="right") +
  scale_x_continuous("", breaks=NULL, expand = c(0, 0)) +
  scale_fill_brewer(palette = "Set1") +
  # scale_fill_manual("Category", values=set_names(qc_categories$color, qc_categories$category), labels=set_names(qc_categories$label, qc_categories$category), guide=guide_legend(ncol=2)) +
  scale_alpha_continuous("Score", guide=guide_legend(ncol=5, label.position = "bottom")) +
  theme_pub() +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1), axis.text.y = element_text(size=12), legend.position="bottom")

plot_individual_checks


##  ............................................................................
##  Highlight some difficult checks                                         ####

# calculate difficulte based on average score
check_scores <- tool_qc_checks %>% group_by(check_id) %>% summarise(score = mean(answer))
aspect_scores <- tool_qc_checks %>% group_by(aspect_id) %>% summarise(score = mean(answer))

check_difficulty_data <- checks %>%
  left_join(check_scores, "check_id") %>%
  left_join(check_position, "check_id")

# construct the heatmap and highlights
plot_check_difficulty <- check_difficulty_data %>%
  ggplot() +
  geom_rect(aes(ymin=check_start, ymax=check_end, xmin=0, xmax=1), fill="#DDDDDD") +
  geom_rect(aes(ymin=check_start, ymax=check_end, xmin=0, xmax=1, fill=score)) +
  ggrepel::geom_label_repel(
    aes(
      1,
      (check_end+check_start)/2,
      label=label_wrap(item, 35)
    ),
    nudge_x = 0.5,
    direction="y",
    data=check_difficulty_data %>%
      filter(score <= 0.5),
    size=5,
    lineheight=0.8,
    min.segment.length = 0,
    hjust=0
  ) +
  geom_segment(aes(x=0, xend=1, y=check_end, yend=check_end), data=check_position, color="#444444", alpha=0.25) +
  geom_segment(aes(x=0, xend=1, y=aspect_end, yend=aspect_end), data=aspect_position, color="#444444") +
  # hline_check + hline_aspect +
  # scale_fill_manual(values=set_names(qc_categories$color, qc_categories$category)) +
  # scale_fill_distiller("QC\ndifficulty", palette="Spectral", limits=c(0,1), breaks=c(0,0.5, 1), direction=1) +
  scale_fill_gradientn("Average QC score across methods", colors = c("#9e0142", "#d53e4f", "#f46d43", "#fee08b", "#abdda4", "#1a9850"), limits=c(0,1), breaks=c(0,0.5, 1), guide=guide_colorbar(title.position = "bottom", title.hjust=0.5, barwidth = unit(2, "inches"))) +
  # viridis::scale_fill_viridis("QC\ndifficulty", limits=c(0,1), breaks=c(0,0.5, 1)) +
  scale_x_continuous(NULL, breaks=NULL, limits=c(0, 12), expand=c(0,0)) +
  scale_y_reverse(NULL, breaks=NULL, expand=c(0,0)) +
  annotate("segment", x=-Inf, xend=-Inf, y=-Inf, yend=Inf)+
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1), legend.position = "bottom")

plot_check_difficulty




##  ............................................................................
##  Create the overview figure                                              ####
plot_qc_overview <- wrap_plots(
  plot_tool_ordering,
  plot_spacer(),
  plot_individual_checks,
  plot_check_difficulty,
  ncol = 2,
  nrow = 2,
  heights = c(0.2, 0.8),
  widths = c(0.8, 0.3)
)


ggsave(
  plot = plot_qc_overview,
  figure_file("qc_overview.svg"),
  width=15,
  height=18
)
